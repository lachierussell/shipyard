# Example nginx site configuration for Shipyard
# This is the config you provide via POST /deploy/frontend as the nginx_config field
# It demonstrates the generated variables that Shipyard provides for the override mechanism
#
# NOTE: If ssl_enabled=true in shipyard.toml for this site, Shipyard will automatically:
#   1. Obtain a Let's Encrypt certificate during site init
#   2. Transform this config to listen on 443 with SSL
#   3. Add modern TLS settings (TLSv1.2/1.3)
#   4. Generate an HTTP->HTTPS redirect block
# So you can write a simple HTTP config and Shipyard handles the HTTPS transformation.

# Generated variables available from override.conf:
#   $frontend_version              — "latest" or a specific commit hash from ?override=
#   $is_override                   — "0" or "1" (whether override is active)
#   $xrobots_value                 — "" or "noindex, nofollow"
#   $override_access_{normalized}  — "0" (deny) or "1" (allow)
#     where {normalized} = domain with dots replaced by underscores
#     Example: $override_access_myapp_example_com

server {
    listen 80;
    server_name myapp.example.com;

    # Root uses the frontend_version variable to select between latest and a specific commit
    root /usr/local/www/myapp.example.com/$frontend_version;
    index index.html;

    # Main location block
    location / {
        # Block override requests from non-whitelisted IPs
        if ($override_access_myapp_example_com = 0) {
            return 403;
        }

        # Add X-Robots-Tag for override requests (empty value = no effect when not override)
        add_header X-Robots-Tag $xrobots_value;

        # For SPA applications: try_files falls back to index.html for client-side routing
        try_files $uri $uri/ /index.html;

        # For plain HTML sites, use this instead:
        # try_files $uri $uri/ =404;
    }

    # Backend proxy (if your site has a backend service)
    location /api/ {
        proxy_pass http://127.0.1.2:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Static files cache (optional)
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
        expires 30d;
        add_header Cache-Control "public, immutable";
    }
}
